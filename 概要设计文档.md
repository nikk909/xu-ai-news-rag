# XU-News-AI-RAG：个性化新闻智能知识库
## 概要设计文档

---

## 1. 文档信息

- **文档名称**：概要设计文档
- **项目名称**：XU-News-AI-RAG：个性化新闻智能知识库
- **文档版本**：v1.0
- **创建日期**：2025年11月9日
- **最后更新**：2025年11月9日

---

## 2. 系统概述

### 2.1 系统简介

XU-News-AI-RAG 是一个基于 RAG（检索增强生成）技术的个性化新闻智能知识库系统，通过自动化新闻采集、智能存储、语义检索和知识分析，为用户提供高效的新闻信息服务。

### 2.2 系统目标

- **自动化采集**：通过定时任务自动从RSS、网页等渠道采集新闻信息
- **智能存储**：将新闻信息转换为向量并存储到FAISS向量数据库，实现高效检索
- **语义检索**：基于自然语言提问，从知识库中检索相关内容
- **知识分析**：提供聚类分析和关键词统计，帮助用户了解知识库内容特征

### 2.3 系统边界

- **输入**：RSS订阅源、网页内容、用户上传文件、用户查询
- **输出**：新闻数据、检索结果、分析报告、邮件通知
- **外部系统**：Ollama大模型服务、邮件服务器、搜索引擎（百度、DuckDuckGo）

---

## 3. 系统架构设计

### 3.1 总体架构

系统采用前后端分离架构：

```
┌─────────────────┐
│   前端 (React)   │
│  - 用户界面      │
│  - 状态管理      │
│  - API调用       │
└────────┬────────┘
         │ HTTP/JSON
         │
┌────────▼────────┐
│  后端 (Flask)    │
│  - API服务       │
│  - 业务逻辑      │
│  - 数据访问      │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
┌───▼───┐ ┌──▼──────┐
│SQLite │ │ FAISS   │
│数据库  │ │向量数据库│
└───────┘ └─────────┘
```

### 3.2 技术架构层次

#### 3.2.1 表现层（前端）
- **框架**：React 18 + Vite
- **UI组件**：Tailwind CSS + Lucide React
- **路由**：React Router
- **状态管理**：React Hooks (useState, useEffect)
- **图表**：Chart.js + react-chartjs-2

#### 3.2.2 业务逻辑层（后端）
- **框架**：Flask 3.0
- **认证**：JWT (PyJWT)
- **密码加密**：bcrypt
- **邮件服务**：Flask-Mail
- **定时任务**：APScheduler

#### 3.2.3 数据访问层
- **关系型数据库**：SQLite（支持MySQL）
- **ORM**：SQLAlchemy
- **向量数据库**：FAISS
- **嵌入模型**：sentence-transformers (all-MiniLM-L6-v2)
- **重排模型**：CrossEncoder (ms-marco-MiniLM-L-6-v2)

#### 3.2.4 AI服务层
- **大语言模型**：Ollama (qwen2.5:4b)
- **文本嵌入**：SentenceTransformer
- **结果重排**：CrossEncoder

---

## 4. 功能模块设计

### 4.1 用户认证模块

#### 4.1.1 功能描述
提供用户注册、登录、身份验证功能。

#### 4.1.2 主要接口
- `POST /api/auth/send-code`：发送验证码
- `POST /api/auth/register`：用户注册
- `POST /api/auth/login`：用户登录
- `GET /api/auth/verify`：验证Token

#### 4.1.3 数据模型
- **User**：用户信息表
  - id, email, password_hash, is_verified, created_at, updated_at
- **VerificationCode**：验证码表
  - id, email, code, created_at, expires_at, is_used

### 4.2 新闻采集模块

#### 4.2.1 功能描述
通过定时任务自动采集新闻，支持RSS订阅和网页抓取。

#### 4.2.2 主要组件
- **NewsCrawler**：新闻爬虫类
  - `crawl_rss(rss_url)`：抓取RSS源
  - `crawl_web(url)`：抓取网页内容
  - `check_robots_txt(url)`：检查robots.txt协议
- **NewsScheduler**：定时任务调度器
  - 每小时执行一次新闻采集
  - 自动入库并发送邮件通知

#### 4.2.3 数据流程
```
RSS/网页 → NewsCrawler → 数据清洗 → 向量化 → 知识库入库 → 邮件通知
```

### 4.3 知识库管理模块

#### 4.3.1 功能描述
管理知识库内容，包括文件上传、查看、编辑、删除、移动等操作。

#### 4.3.2 主要接口
- `GET /api/knowledge/kb-list`：获取知识库列表
- `GET /api/knowledge/stats`：获取知识库统计信息
- `POST /api/knowledge/upload`：上传文件
- `GET /api/knowledge/files/<kb_name>`：获取文件列表
- `DELETE /api/knowledge/files/<kb_name>/<filename>`：删除文件
- `PUT /api/knowledge/files/<kb_name>/<filename>`：编辑元数据
- `POST /api/knowledge/files/<kb_name>/<filename>/move`：移动文件

#### 4.3.3 数据模型
- **FileMetadata**：文件元数据表
  - id, kb_name, filename, tags, source, created_at, updated_at

### 4.4 语义检索模块

#### 4.4.1 功能描述
基于用户提问，从知识库中检索相关内容，支持相似度排序和联网查询。

#### 4.4.2 主要组件
- **KnowledgeBase**：知识库类
  - `add_documents(texts, metadata)`：添加文档
  - `search(query, top_k)`：向量检索
  - `search_with_rerank(query, top_k)`：检索+重排
- **WebSearcher**：联网搜索类
  - `search(query, top_k)`：联网搜索

#### 4.4.3 检索流程
```
用户提问 → 向量化 → FAISS检索 → 重排序 → 返回结果
                ↓ (无结果)
            联网搜索 → 大模型推理 → 返回结果
```

#### 4.4.4 主要接口
- `POST /api/knowledge/search`：语义检索

### 4.5 数据分析模块

#### 4.5.1 功能描述
提供知识库数据聚类分析和关键词统计。

#### 4.5.2 主要功能
- **关键词提取**：基于jieba分词和TF-IDF统计
- **聚类分析**：基于关键词相似度的快速聚类算法
- **可视化展示**：关键词Top10分布图表、聚类分布图表

#### 4.5.3 主要接口
- `POST /api/knowledge/analysis`：执行分析任务
- `GET /api/knowledge/analysis-task/<task_id>`：获取分析任务状态

#### 4.5.4 分析流程
```
文档集合 → 关键词提取 → 聚类分析 → 结果可视化
```

---

## 5. 数据库设计

### 5.1 关系型数据库设计

#### 5.1.1 用户表 (users)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键，自增 |
| email | VARCHAR(255) | 邮箱，唯一索引 |
| password_hash | VARCHAR(255) | 密码哈希值 |
| is_verified | BOOLEAN | 是否已验证 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### 5.1.2 验证码表 (verification_codes)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键，自增 |
| email | VARCHAR(255) | 邮箱，索引 |
| code | VARCHAR(6) | 验证码 |
| created_at | DATETIME | 创建时间 |
| expires_at | DATETIME | 过期时间 |
| is_used | BOOLEAN | 是否已使用 |

#### 5.1.3 文件元数据表 (file_metadata)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键，自增 |
| kb_name | VARCHAR(255) | 知识库名称，索引 |
| filename | VARCHAR(500) | 文件名，索引 |
| tags | TEXT | 标签（JSON或逗号分隔） |
| source | VARCHAR(500) | 来源 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**索引设计**：
- `idx_kb_filename`：联合唯一索引 (kb_name, filename)

### 5.2 向量数据库设计

#### 5.2.1 FAISS索引结构
- **索引类型**：IndexFlatIP（内积索引，用于余弦相似度）
- **向量维度**：768（all-MiniLM-L6-v2模型输出）
- **存储方式**：
  - `index.faiss`：FAISS索引文件
  - `documents.pkl`：文档元数据文件（包含文本、元数据、向量）

#### 5.2.2 文档结构
```python
{
    'text': '文档文本内容',
    'metadata': {
        'title': '标题',
        'source': '来源',
        'file_name': '文件名',
        'created_at': '创建时间'
    },
    'vector': numpy.array([...])  # 768维向量
}
```

---

## 6. 接口设计

### 6.1 认证接口

#### 6.1.1 发送验证码
```
POST /api/auth/send-code
Request: { "email": "user@example.com" }
Response: { "message": "验证码已发送" }
```

#### 6.1.2 用户注册
```
POST /api/auth/register
Request: { "email": "user@example.com", "password": "password", "code": "123456" }
Response: { "message": "注册成功", "token": "..." }
```

#### 6.1.3 用户登录
```
POST /api/auth/login
Request: { "email": "user@example.com", "password": "password" }
Response: { "token": "...", "user": {...} }
```

### 6.2 知识库接口

#### 6.2.1 语义检索
```
POST /api/knowledge/search
Request: {
    "query": "用户提问",
    "kb_names": ["default"],
    "top_k": 5,
    "page": 1,
    "page_size": 10
}
Response: {
    "results": [...],
    "reply": "大模型生成的回复",
    "total": 100,
    "total_pages": 10
}
```

#### 6.2.2 文件上传
```
POST /api/knowledge/upload
Request: FormData { file, kb_name }
Response: { "message": "上传成功", "filename": "..." }
```

### 6.3 分析接口

#### 6.3.1 创建分析任务
```
POST /api/knowledge/analysis
Request: {
    "kb_name": "知识库名称",
    "filename": "文件名" (可选，单文件分析)
}
Response: { "task_id": "...", "message": "分析任务已创建" }
```

#### 6.3.2 获取分析结果
```
GET /api/knowledge/analysis-task/<task_id>
Response: {
    "status": "completed",
    "result": {
        "clusters": [...],
        "top_keywords": [...],
        "summary": "..."
    }
}
```

---

## 7. 安全设计

### 7.1 身份认证
- **JWT Token**：用户登录后获得Token，后续请求携带Token验证身份
- **Token过期**：Token有效期24小时，过期需重新登录
- **密码加密**：使用bcrypt进行密码哈希存储

### 7.2 数据安全
- **SQL注入防护**：使用SQLAlchemy ORM，参数化查询
- **XSS防护**：前端对用户输入进行转义
- **文件上传限制**：限制文件类型和大小

### 7.3 网络爬虫规范
- **robots.txt遵守**：检查并遵守目标网站的robots.txt协议
- **访问频率控制**：限制访问频率，避免被封禁
- **User-Agent设置**：使用真实的浏览器User-Agent

---

## 8. 性能设计

### 8.1 检索性能
- **向量检索**：FAISS索引，检索速度 < 100ms（10万条数据）
- **结果重排**：CrossEncoder重排，响应时间 < 500ms
- **缓存机制**：常用查询结果缓存（可选）

### 8.2 并发处理
- **异步任务**：分析任务在后台线程执行，避免阻塞
- **连接池**：数据库连接池，支持并发访问
- **任务队列**：分析任务支持取消和状态查询

### 8.3 存储优化
- **向量压缩**：FAISS索引支持压缩存储
- **文件分片**：大文件自动分片处理
- **索引重建**：支持索引重建和增量更新

---

## 9. 部署设计

### 9.1 部署架构
- **前端**：静态文件部署，支持Nginx反向代理
- **后端**：Flask应用，支持Gunicorn多进程部署
- **数据库**：SQLite（开发）/ MySQL（生产）
- **向量库**：FAISS本地存储

### 9.2 环境要求
- **Python**：3.8+
- **Node.js**：16+
- **Ollama**：本地部署qwen2.5:4b模型
- **内存**：建议8GB+
- **存储**：根据数据量确定

### 9.3 配置管理
- **环境变量**：使用`.env`文件管理配置
- **敏感信息**：密码、密钥等通过环境变量配置
- **日志管理**：日志文件分级存储

---

## 10. 扩展性设计

### 10.1 功能扩展
- **多语言支持**：可扩展支持多语言新闻采集和检索
- **推荐算法**：可集成个性化推荐功能
- **实时推送**：可扩展WebSocket实时推送功能

### 10.2 性能扩展
- **分布式部署**：支持多实例部署，负载均衡
- **向量库扩展**：可迁移到分布式向量数据库（如Milvus）
- **缓存扩展**：可集成Redis缓存

### 10.3 数据扩展
- **数据源扩展**：支持更多新闻源和数据类型
- **存储扩展**：支持对象存储（如S3）存储大文件
- **分析扩展**：支持更多分析维度和算法

---

## 11. 异常处理

### 11.1 错误分类
- **业务错误**：参数错误、权限不足等，返回4xx状态码
- **系统错误**：数据库连接失败、服务异常等，返回5xx状态码
- **网络错误**：请求超时、连接失败等，返回友好错误提示

### 11.2 错误处理策略
- **前端**：统一错误处理，显示友好错误提示
- **后端**：异常捕获，记录日志，返回标准错误响应
- **重试机制**：网络请求支持自动重试

---

## 12. 日志设计

### 12.1 日志级别
- **INFO**：正常操作日志
- **WARNING**：警告信息
- **ERROR**：错误信息
- **DEBUG**：调试信息（开发环境）

### 12.2 日志内容
- **请求日志**：记录API请求和响应
- **业务日志**：记录关键业务操作
- **错误日志**：记录异常和错误堆栈
- **性能日志**：记录关键操作耗时

---

**文档版本**：v1.0  
**创建日期**：2025年11月9日  
**最后更新**：2025年11月9日

