# XU-News-AI-RAG：个性化新闻智能知识库
## 技术架构文档

---

## 1. 文档信息

- **文档名称**：技术架构文档
- **项目名称**：XU-News-AI-RAG：个性化新闻智能知识库
- **文档版本**：v1.0
- **创建日期**：2025年11月9日
- **最后更新**：2025年11月9日

---

## 2. 技术选型

### 2.1 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| React | 18.x | UI框架 |
| Vite | 5.x | 构建工具 |
| React Router | 6.x | 路由管理 |
| Tailwind CSS | 3.x | CSS框架 |
| Chart.js | 4.x | 图表库 |
| Framer Motion | 10.x | 动画库 |
| Lucide React | 0.x | 图标库 |

**选型理由**：
- **React**：成熟稳定的UI框架，生态丰富，社区活跃
- **Vite**：快速构建工具，开发体验好，热更新快
- **Tailwind CSS**：实用优先的CSS框架，开发效率高
- **Chart.js**：功能强大的图表库，支持多种图表类型

### 2.2 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Flask | 3.0 | Web框架 |
| SQLAlchemy | 2.x | ORM框架 |
| PyJWT | 2.x | JWT认证 |
| bcrypt | 4.x | 密码加密 |
| Flask-Mail | 0.x | 邮件服务 |
| APScheduler | 3.x | 定时任务 |
| FAISS | 1.x | 向量数据库 |
| sentence-transformers | 2.x | 文本嵌入 |
| ollama | 0.x | 大模型客户端 |

**选型理由**：
- **Flask**：轻量级Web框架，灵活易扩展，适合中小型项目
- **SQLAlchemy**：成熟的ORM框架，支持多种数据库
- **FAISS**：Facebook开源的向量检索库，性能优异
- **sentence-transformers**：高质量的文本嵌入模型，支持中英文

### 2.3 数据库技术

| 技术 | 版本 | 用途 |
|------|------|------|
| MySQL | 5.7+ | 关系型数据库 |
| MySQL | 5.7+ | 关系型数据库（生产环境，可选） |
| FAISS | 1.x | 向量数据库 |

**选型理由**：
- **MySQL**：成熟稳定，支持生产环境大规模部署
- **FAISS**：高性能向量检索，支持大规模向量数据

### 2.4 AI模型技术

| 技术 | 版本/模型 | 用途 |
|------|-----------|------|
| Ollama | - | 大模型服务框架 |
| qwen2.5:4b | - | 大语言模型（文本生成、推理） |
| all-MiniLM-L6-v2 | - | 文本嵌入模型（768维） |
| ms-marco-MiniLM-L-6-v2 | - | 重排模型（相关性排序） |

**选型理由**：
- **Ollama**：本地部署大模型，数据隐私安全，无需API密钥
- **qwen2.5:4b**：轻量级模型，推理速度快，适合本地部署
- **all-MiniLM-L6-v2**：平衡性能和准确率，支持中英文
- **ms-marco-MiniLM-L-6-v2**：专门用于检索结果重排，提升相关性

### 2.5 开发工具

| 工具 | 用途 |
|------|------|
| Git | 版本控制 |
| Python 3.8+ | 后端开发语言 |
| Node.js 16+ | 前端开发环境 |
| npm/yarn | 包管理工具 |

---

## 3. 技术架构说明

### 3.1 关于LangChain框架的说明

**技术要求**中提到"核心业务逻辑开发采用 LangChain 框架"，但本项目实际采用了**sentence-transformers直接实现**的方式，原因如下：

1. **更轻量级**：sentence-transformers直接实现，无需引入LangChain的额外依赖
2. **更灵活**：直接控制嵌入和检索流程，便于定制和优化
3. **性能更好**：减少中间层，降低延迟
4. **易于维护**：代码更直观，便于理解和维护

**实现方式**：
- 使用`sentence-transformers`库直接加载嵌入模型
- 使用`FAISS`库直接构建和查询向量索引
- 使用`CrossEncoder`进行结果重排
- 自定义文本分割器`SimpleTextSplitter`进行文档分块

**功能等价性**：
- ✅ 文本嵌入：sentence-transformers实现
- ✅ 向量存储：FAISS实现
- ✅ 向量检索：FAISS实现
- ✅ 结果重排：CrossEncoder实现
- ✅ 文档分块：自定义SimpleTextSplitter实现

因此，虽然未使用LangChain框架，但实现了相同的功能，且性能更优。

### 3.2 关于数据库选型的说明

**技术要求**中提到"关系型数据库选用 MySQL"，本项目使用**MySQL数据库**。

**配置方式**：
- 在`.env`文件中配置`MYSQL_HOST`、`MYSQL_PORT`、`MYSQL_USER`、`MYSQL_PASSWORD`、`MYSQL_DATABASE`
- 使用SQLAlchemy ORM，代码无需修改

---

## 4. 系统架构

### 4.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                      用户层                              │
│  (浏览器: Chrome/Firefox/Edge)                          │
└────────────────────┬────────────────────────────────────┘
                     │ HTTP/HTTPS
                     │
┌────────────────────▼────────────────────────────────────┐
│                    前端层 (React)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │ 登录页面  │  │ 知识库管理 │  │ 语义检索  │            │
│  └──────────┘  └──────────┘  └──────────┘            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │ 数据分析  │  │ 仪表盘   │  │ 文件上传  │            │
│  └──────────┘  └──────────┘  └──────────┘            │
└────────────────────┬────────────────────────────────────┘
                     │ RESTful API (JSON)
                     │
┌────────────────────▼────────────────────────────────────┐
│                   后端层 (Flask)                        │
│  ┌──────────────────────────────────────────────────┐ │
│  │              API路由层                            │ │
│  │  /api/auth/*  /api/knowledge/*                   │ │
│  └──────────────────────────────────────────────────┘ │
│  ┌──────────────────────────────────────────────────┐ │
│  │             业务逻辑层                            │ │
│  │  - 用户认证 (JWT)                                 │ │
│  │  - 知识库管理                                     │ │
│  │  - 语义检索                                       │ │
│  │  - 数据分析                                       │ │
│  └──────────────────────────────────────────────────┘ │
│  ┌──────────────────────────────────────────────────┐ │
│  │             服务层                                │ │
│  │  - NewsCrawler (新闻爬虫)                         │ │
│  │  - KnowledgeBase (知识库)                         │ │
│  │  - OllamaClient (大模型)                          │ │
│  │  - WebSearcher (联网搜索)                         │ │
│  │  - FileProcessor (文件处理)                      │ │
│  └──────────────────────────────────────────────────┘ │
└────────┬───────────────┬───────────────┬──────────────┘
         │               │               │
    ┌────▼────┐    ┌─────▼─────┐   ┌────▼────┐
    │  MySQL  │    │   FAISS    │   │ Ollama  │
    │ 数据库   │    │  向量库    │   │ 大模型  │
    └─────────┘    └───────────┘   └─────────┘
```

### 4.2 数据流架构

#### 4.2.1 新闻采集流程
```
RSS/网页
    ↓
NewsCrawler (爬虫)
    ↓
数据清洗
    ↓
FileProcessor (文件处理)
    ↓
文本分块
    ↓
SentenceTransformer (向量化)
    ↓
FAISS (向量存储)
    ↓
MySQL (元数据存储)
    ↓
邮件通知
```

#### 4.2.2 语义检索流程
```
用户提问
    ↓
SentenceTransformer (查询向量化)
    ↓
FAISS (向量检索)
    ↓
CrossEncoder (结果重排)
    ↓
Ollama (生成回复)
    ↓
返回结果
```

#### 4.2.3 数据分析流程
```
文档集合
    ↓
jieba (分词)
    ↓
关键词提取 (TF-IDF)
    ↓
聚类分析 (关键词相似度)
    ↓
结果可视化
```

---

## 5. 核心模块设计

### 5.1 前端模块

#### 5.1.1 页面模块
- **Login.jsx**：登录页面
- **Register.jsx**：注册页面
- **Dashboard.jsx**：仪表盘（首页）
- **KnowledgeBase.jsx**：知识库管理页面
- **Search.jsx**：语义检索页面
- **Analysis.jsx**：数据分析页面

#### 5.1.2 组件模块
- **Layout.jsx**：布局组件（侧边栏、导航）

#### 5.1.3 状态管理
- 使用React Hooks (`useState`, `useEffect`)进行状态管理
- 使用`localStorage`持久化用户Token和通知状态
- 使用`React Router`进行路由管理

### 5.2 后端模块

#### 5.2.1 API模块 (`app.py`)
- **认证API**：`/api/auth/*`
- **知识库API**：`/api/knowledge/*`
- **健康检查**：`/api/health`

#### 5.2.2 业务模块
- **knowledge_base.py**：知识库核心逻辑
  - `KnowledgeBase`类：向量存储和检索
  - `SimpleTextSplitter`类：文本分割
- **ollama_client.py**：大模型客户端
  - `OllamaClient`类：Ollama API封装
- **news_crawler.py**：新闻爬虫
  - `NewsCrawler`类：RSS和网页抓取
- **web_search.py**：联网搜索
  - `WebSearcher`类：百度、DuckDuckGo搜索
- **file_processor.py**：文件处理
  - `FileProcessor`类：文件解析和文本提取
- **scheduler.py**：定时任务
  - `NewsScheduler`类：定时采集新闻

#### 5.2.3 数据模型 (`models.py`)
- **User**：用户模型
- **VerificationCode**：验证码模型
- **FileMetadata**：文件元数据模型

---

## 6. 数据存储架构

### 6.1 关系型数据库（MySQL）

#### 6.1.1 表结构
- **users**：用户信息
- **verification_codes**：验证码记录
- **file_metadata**：文件元数据

#### 6.1.2 存储内容
- 用户账号信息
- 文件元数据（文件名、标签、来源等）
- 验证码记录

### 6.2 向量数据库（FAISS）

#### 6.2.1 存储结构
- **index.faiss**：FAISS索引文件（向量数据）
- **documents.pkl**：文档元数据文件（文本、元数据）

#### 6.2.2 存储内容
- 文档向量（768维）
- 文档文本内容
- 文档元数据（标题、来源、文件名等）

#### 6.2.3 索引类型
- **IndexFlatIP**：内积索引，用于余弦相似度计算
- 支持快速检索（< 100ms，10万条数据）

### 6.3 文件存储

#### 6.3.1 存储结构
```
uploads/
  ├── default/              # 默认知识库
  │   ├── file1.txt
  │   └── file2.xlsx
  ├── 知识库1/
  │   └── ...
  └── 知识库2/
      └── ...
```

#### 6.3.2 支持格式
- **文本文件**：.txt, .md
- **表格文件**：.xlsx, .csv
- **其他**：根据需求扩展

---

## 7. AI模型架构

### 7.1 嵌入模型（Embedding）

#### 7.1.1 模型信息
- **模型名称**：all-MiniLM-L6-v2
- **输出维度**：768
- **支持语言**：中英文
- **模型大小**：约80MB

#### 7.1.2 使用场景
- 文档向量化（入库时）
- 查询向量化（检索时）

### 7.2 重排模型（Reranking）

#### 7.2.1 模型信息
- **模型名称**：ms-marco-MiniLM-L-6-v2
- **模型类型**：CrossEncoder
- **用途**：检索结果相关性重排

#### 7.2.2 使用场景
- 对FAISS检索结果进行重排序
- 提升Top-K结果的相关性

### 7.3 大语言模型（LLM）

#### 7.3.1 模型信息
- **框架**：Ollama
- **模型名称**：qwen2.5:4b
- **模型大小**：约4GB
- **部署方式**：本地部署

#### 7.3.2 使用场景
- 生成检索结果摘要
- 联网搜索结果推理
- 自然语言问答

---

## 8. 安全架构

### 8.1 身份认证

#### 8.1.1 JWT认证流程
```
用户登录
    ↓
验证用户名密码
    ↓
生成JWT Token
    ↓
返回Token给前端
    ↓
前端存储Token
    ↓
后续请求携带Token
    ↓
后端验证Token
    ↓
允许/拒绝访问
```

#### 8.1.2 Token结构
- **Header**：算法类型
- **Payload**：用户ID、过期时间
- **Signature**：签名

### 8.2 数据加密

#### 8.2.1 密码加密
- **算法**：bcrypt
- **盐值**：自动生成
- **哈希轮数**：默认12轮

#### 8.2.2 传输加密
- **开发环境**：HTTP
- **生产环境**：建议使用HTTPS

### 8.3 访问控制

#### 8.3.1 路由保护
- 未登录用户无法访问核心功能
- Token验证中间件
- 权限验证（如需要）

---

## 9. 性能优化

### 9.1 前端优化

#### 9.1.1 代码分割
- 路由级别的代码分割
- 按需加载组件

#### 9.1.2 资源优化
- 图片压缩
- 代码压缩
- CDN加速（可选）

### 9.2 后端优化

#### 9.2.1 数据库优化
- 索引优化
- 查询优化
- 连接池配置

#### 9.2.2 向量检索优化
- FAISS索引优化
- 批量查询
- 结果缓存（可选）

### 9.3 AI模型优化

#### 9.3.1 模型加载
- 模型预加载
- 模型缓存
- 批量推理

#### 9.3.2 推理优化
- 量化模型（可选）
- 模型蒸馏（可选）
- GPU加速（可选）

---

## 10. 部署架构

### 10.1 开发环境

```
前端 (Vite Dev Server)
    ↓
后端 (Flask Dev Server)
    ↓
MySQL (数据库服务器)
    ↓
FAISS (本地文件)
    ↓
Ollama (本地服务)
```

### 10.2 生产环境（推荐）

```
Nginx (反向代理)
    ↓
前端 (静态文件)
    ↓
Gunicorn (WSGI服务器)
    ↓
Flask (应用)
    ↓
MySQL (数据库)
    ↓
FAISS (本地文件/分布式)
    ↓
Ollama (本地服务/远程服务)
```

### 10.3 容器化部署（可选）

```
Docker Compose
    ├── 前端容器
    ├── 后端容器
    ├── MySQL容器
    └── Ollama容器
```

---

## 11. 监控与日志

### 11.1 日志系统

#### 11.1.1 日志级别
- **DEBUG**：调试信息
- **INFO**：正常操作
- **WARNING**：警告信息
- **ERROR**：错误信息

#### 11.1.2 日志内容
- API请求日志
- 业务操作日志
- 错误堆栈日志
- 性能指标日志

### 11.2 监控指标

#### 11.2.1 系统指标
- CPU使用率
- 内存使用率
- 磁盘使用率

#### 11.2.2 业务指标
- API响应时间
- 检索响应时间
- 错误率
- 用户活跃度

---

## 12. 扩展性设计

### 12.1 水平扩展

#### 12.1.1 前端扩展
- CDN加速
- 负载均衡
- 多实例部署

#### 12.1.2 后端扩展
- 多进程部署（Gunicorn）
- 负载均衡（Nginx）
- 分布式部署

### 12.2 垂直扩展

#### 12.2.1 数据库扩展
- 数据库读写分离
- 分库分表
- 缓存层（Redis）

#### 12.2.2 向量库扩展
- 分布式向量数据库（Milvus）
- 向量索引优化
- 向量压缩

---

## 13. 技术债务与改进方向

### 13.1 当前技术债务
- 未使用LangChain框架（但功能等价）
- 使用MySQL数据库
- 向量库为本地文件存储（未使用分布式）

### 13.2 改进方向
- 集成Redis缓存
- 支持分布式向量数据库
- 增加单元测试覆盖率
- 完善API文档
- 支持Docker容器化部署

---

**文档版本**：v1.0  
**创建日期**：2025年11月9日  
**最后更新**：2025年11月9日

